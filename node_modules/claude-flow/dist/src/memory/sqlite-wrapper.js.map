{"version":3,"sources":["../../../src/memory/sqlite-wrapper.js"],"sourcesContent":["/**\n * SQLite Wrapper with Windows Fallback Support\n * Provides graceful fallback when better-sqlite3 fails to load\n */\n\nimport { createRequire } from 'module';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nlet Database = null;\nlet sqliteAvailable = false;\nlet loadError = null;\n\n/**\n * Try to load better-sqlite3 with comprehensive error handling\n */\nasync function tryLoadSQLite() {\n  try {\n    // Try CommonJS require first (more reliable in Node.js)\n    const require = createRequire(import.meta.url);\n    Database = require('better-sqlite3');\n    sqliteAvailable = true;\n    return true;\n  } catch (requireErr) {\n    // Fallback to ES module import\n    try {\n      const module = await import('better-sqlite3');\n      Database = module.default;\n      sqliteAvailable = true;\n      return true;\n    } catch (importErr) {\n      loadError = importErr;\n      \n      // Check for specific Windows errors\n      if (requireErr.message.includes('was compiled against a different Node.js version') ||\n          requireErr.message.includes('Could not locate the bindings file') ||\n          requireErr.message.includes('The specified module could not be found') ||\n          requireErr.code === 'MODULE_NOT_FOUND') {\n        \n        console.warn(`\n╔══════════════════════════════════════════════════════════════════════════════╗\n║                     Windows SQLite Installation Issue                         ║\n╠══════════════════════════════════════════════════════════════════════════════╣\n║                                                                              ║\n║  The native SQLite module failed to load. This is common on Windows when    ║\n║  using 'npx' or when node-gyp build tools are not available.               ║\n║                                                                              ║\n║  Claude Flow will continue with in-memory storage (non-persistent).         ║\n║                                                                              ║\n║  To enable persistent storage on Windows:                                    ║\n║                                                                              ║\n║  Option 1 - Install Windows Build Tools:                                    ║\n║  > npm install --global windows-build-tools                                 ║\n║  > npm install claude-flow@alpha                                           ║\n║                                                                              ║\n║  Option 2 - Use Pre-built Binaries:                                        ║\n║  > npm config set python python3                                           ║\n║  > npm install claude-flow@alpha --build-from-source=false                 ║\n║                                                                              ║\n║  Option 3 - Use WSL (Windows Subsystem for Linux):                         ║\n║  Install WSL and run Claude Flow inside a Linux environment                 ║\n║                                                                              ║\n╚══════════════════════════════════════════════════════════════════════════════╝\n`);\n      }\n      \n      return false;\n    }\n  }\n}\n\n/**\n * Check if SQLite is available\n */\nexport async function isSQLiteAvailable() {\n  if (sqliteAvailable !== null) {\n    return sqliteAvailable;\n  }\n  \n  await tryLoadSQLite();\n  return sqliteAvailable;\n}\n\n/**\n * Get SQLite Database constructor or null\n */\nexport async function getSQLiteDatabase() {\n  if (!sqliteAvailable && loadError === null) {\n    await tryLoadSQLite();\n  }\n  \n  return Database;\n}\n\n/**\n * Get the load error if any\n */\nexport function getLoadError() {\n  return loadError;\n}\n\n/**\n * Create a SQLite database instance with fallback\n */\nexport async function createDatabase(dbPath) {\n  const DB = await getSQLiteDatabase();\n  \n  if (!DB) {\n    throw new Error('SQLite is not available. Use fallback storage instead.');\n  }\n  \n  try {\n    return new DB(dbPath);\n  } catch (err) {\n    // Additional Windows-specific error handling\n    if (err.message.includes('EPERM') || err.message.includes('access denied')) {\n      throw new Error(`Cannot create database at ${dbPath}. Permission denied. Try using a different directory or running with administrator privileges.`);\n    }\n    throw err;\n  }\n}\n\n/**\n * Check if running on Windows\n */\nexport function isWindows() {\n  return process.platform === 'win32';\n}\n\n/**\n * Get platform-specific storage recommendations\n */\nexport function getStorageRecommendations() {\n  if (isWindows()) {\n    return {\n      recommended: 'in-memory',\n      reason: 'Windows native module compatibility',\n      alternatives: [\n        'Install Windows build tools for SQLite support',\n        'Use WSL (Windows Subsystem for Linux)',\n        'Use Docker container with Linux'\n      ]\n    };\n  }\n  \n  return {\n    recommended: 'sqlite',\n    reason: 'Best performance and persistence',\n    alternatives: ['in-memory for testing']\n  };\n}\n\n// Pre-load SQLite on module import\ntryLoadSQLite().catch(() => {\n  // Silently handle initial load failure\n});\n\nexport default {\n  isSQLiteAvailable,\n  getSQLiteDatabase,\n  getLoadError,\n  createDatabase,\n  isWindows,\n  getStorageRecommendations\n};"],"names":["createRequire","path","fileURLToPath","__filename","url","__dirname","dirname","Database","sqliteAvailable","loadError","tryLoadSQLite","require","requireErr","module","default","importErr","message","includes","code","console","warn","isSQLiteAvailable","getSQLiteDatabase","getLoadError","createDatabase","dbPath","DB","Error","err","isWindows","process","platform","getStorageRecommendations","recommended","reason","alternatives","catch"],"mappings":"AAKA,SAASA,aAAa,QAAQ,SAAS;AACvC,OAAOC,UAAU,OAAO;AACxB,SAASC,aAAa,QAAQ,MAAM;AAEpC,MAAMC,aAAaD,cAAc,YAAYE,GAAG;AAChD,MAAMC,YAAYJ,KAAKK,OAAO,CAACH;AAE/B,IAAII,WAAW;AACf,IAAIC,kBAAkB;AACtB,IAAIC,YAAY;AAKhB,eAAeC;IACb,IAAI;QAEF,MAAMC,UAAUX,cAAc,YAAYI,GAAG;QAC7CG,WAAWI,QAAQ;QACnBH,kBAAkB;QAClB,OAAO;IACT,EAAE,OAAOI,YAAY;QAEnB,IAAI;YACF,MAAMC,SAAS,MAAM,MAAM,CAAC;YAC5BN,WAAWM,OAAOC,OAAO;YACzBN,kBAAkB;YAClB,OAAO;QACT,EAAE,OAAOO,WAAW;YAClBN,YAAYM;YAGZ,IAAIH,WAAWI,OAAO,CAACC,QAAQ,CAAC,uDAC5BL,WAAWI,OAAO,CAACC,QAAQ,CAAC,yCAC5BL,WAAWI,OAAO,CAACC,QAAQ,CAAC,8CAC5BL,WAAWM,IAAI,KAAK,oBAAoB;gBAE1CC,QAAQC,IAAI,CAAC,CAAC;;;;;;;;;;;;;;;;;;;;;;;;AAwBtB,CAAC;YACK;YAEA,OAAO;QACT;IACF;AACF;AAKA,OAAO,eAAeC;IACpB,IAAIb,oBAAoB,MAAM;QAC5B,OAAOA;IACT;IAEA,MAAME;IACN,OAAOF;AACT;AAKA,OAAO,eAAec;IACpB,IAAI,CAACd,mBAAmBC,cAAc,MAAM;QAC1C,MAAMC;IACR;IAEA,OAAOH;AACT;AAKA,OAAO,SAASgB;IACd,OAAOd;AACT;AAKA,OAAO,eAAee,eAAeC,MAAM;IACzC,MAAMC,KAAK,MAAMJ;IAEjB,IAAI,CAACI,IAAI;QACP,MAAM,IAAIC,MAAM;IAClB;IAEA,IAAI;QACF,OAAO,IAAID,GAAGD;IAChB,EAAE,OAAOG,KAAK;QAEZ,IAAIA,IAAIZ,OAAO,CAACC,QAAQ,CAAC,YAAYW,IAAIZ,OAAO,CAACC,QAAQ,CAAC,kBAAkB;YAC1E,MAAM,IAAIU,MAAM,CAAC,0BAA0B,EAAEF,OAAO,8FAA8F,CAAC;QACrJ;QACA,MAAMG;IACR;AACF;AAKA,OAAO,SAASC;IACd,OAAOC,QAAQC,QAAQ,KAAK;AAC9B;AAKA,OAAO,SAASC;IACd,IAAIH,aAAa;QACf,OAAO;YACLI,aAAa;YACbC,QAAQ;YACRC,cAAc;gBACZ;gBACA;gBACA;aACD;QACH;IACF;IAEA,OAAO;QACLF,aAAa;QACbC,QAAQ;QACRC,cAAc;YAAC;SAAwB;IACzC;AACF;AAGAzB,gBAAgB0B,KAAK,CAAC,KAEtB;AAEA,eAAe;IACbf;IACAC;IACAC;IACAC;IACAK;IACAG;AACF,EAAE"}